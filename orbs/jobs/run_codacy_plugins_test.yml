description: "Runs codacy-plugins-test on a tool"

machine: true

parameters:
  run_json_tests:
    type: boolean
    default: true
    description: "Run 'json' tests in codacy-plugins-test"
  run_pattern_tests:
    type: boolean
    default: true
    description: "Run 'pattern' tests in codacy-plugins-test"
  run_plugin_tests:
    type: boolean
    default: false
    description: "Run 'plugin' tests in codacy-plugins-test"
  docker_image_name:
    type: string
    default: $CIRCLE_PROJECT_REPONAME
    description: "Tool docker image name"
  docker_image_tag:
    type: string
    default: latest
    description: "Tool docker image tag"

steps:
  - attach_workspace:
      at: ~/
  - restore_cache:
      key: codacy-plugins-test-cache-$CODACY_PLUGINS_TEST_VERSION # version injected as environment in .circle/config.yml
  - attach_workspace:
      at: ~/
  - run:
      command: |
        mkdir -p codacy-plugins-test
        cd codacy-plugins-test
        LINK="https://bintray.com/codacy/Binaries/download_file?file_path=$CODACY_PLUGINS_TEST_VERSION%2Fcodacy-plugins-test-linux"
        if [ ! -f "$FILENAME" ]; then
          wget $LINK -O $FILENAME
          chmod +x $FILENAME
        fi
        docker load --input ~/workdir/docker-image.tar
  - when:
      condition: << parameters.run_json_tests >>
      steps:
        - run:
            name: RunJsonTests
            command: |
              ./$FILENAME json << parameters.docker_image_name >>:<< parameters.docker_image_tag >>
  - when:
      condition: << parameters.run_pattern_tests >>
      steps:
        - run:
            name: RunPatternTests
            command: |
              ./$FILENAME pattern << parameters.docker_image_name >>:<< parameters.docker_image_tag >>
  - when:
      condition: << parameters.run_plugin_tests >>
      steps:
        - run:
            name: RunPluginTests
            command: |
              ./$FILENAME plugin << parameters.docker_image_name >>:<< parameters.docker_image_tag >>
  - save_cache:
      key: codacy-plugins-test-cache-$CODACY_PLUGINS_TEST_VERSION
      paths:
        - ~/codacy-plugins-test
